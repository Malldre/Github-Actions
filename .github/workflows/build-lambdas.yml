name: "Build Lambda Functions"

on:
  workflow_call:
    inputs:
      lambda-names:
        description: "Comma-separated list of lambda function names to build (e.g., 'get_schema,list_schema,upload_schema'). Leave empty to auto-detect all lambdas in directory."
        required: false
        type: string
        default: ""
      lambdas-directory:
        description: "Base directory containing lambda functions"
        required: false
        type: string
        default: "lambdas"
      node-version:
        description: "Node.js version to use for building"
        required: false
        type: string
        default: "20"
      output-directory:
        description: "Directory to output packaged lambda ZIP files"
        required: false
        type: string
        default: "lambdas/output"
      artifact-name:
        description: "Name of the artifact to upload"
        required: false
        type: string
        default: "lambda-packages"
      retention-days:
        description: "Number of days to retain artifacts"
        required: false
        type: number
        default: 1
      build-directory:
        description: "Directory name containing built files (e.g., 'build', 'dist')"
        required: false
        type: string
        default: "build"
      include-node-modules:
        description: "Include node_modules in package"
        required: false
        type: boolean
        default: true
      include-package-json:
        description: "Include package.json and package-lock.json in package"
        required: false
        type: boolean
        default: true
    outputs:
      artifacts-uploaded:
        description: "Indicates if artifacts were successfully uploaded"
        value: ${{ jobs.build.outputs.success }}
      package-count:
        description: "Number of lambda packages created"
        value: ${{ jobs.build.outputs.package-count }}

permissions:
  contents: read

jobs:
  build:
    name: Build and Package Lambdas
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      success: ${{ steps.upload.outcome == 'success' }}
      package-count: ${{ steps.count.outputs.count }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ========================================
      # Setup Node.js
      # ========================================

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      # ========================================
      # Parse Lambda Names
      # ========================================

      - name: Auto-detect or parse lambda names
        id: parse-lambdas
        run: |
          LAMBDA_NAMES="${{ inputs.lambda-names }}"
          LAMBDAS_DIR="${{ inputs.lambdas-directory }}"

          # Auto-detect if lambda-names is empty
          if [ -z "$LAMBDA_NAMES" ]; then
            echo "ÔøΩ Auto-detecting lambdas in directory: $LAMBDAS_DIR"
            
            if [ ! -d "$LAMBDAS_DIR" ]; then
              echo "‚ùå Directory not found: $LAMBDAS_DIR"
              exit 1
            fi
            
            # Find all subdirectories with package.json
            DETECTED_LAMBDAS=()
            for dir in "$LAMBDAS_DIR"/*/ ; do
              if [ -d "$dir" ]; then
                LAMBDA_NAME=$(basename "$dir")
                
                # Check if it has package.json
                if [ -f "$dir/package.json" ]; then
                  DETECTED_LAMBDAS+=("$LAMBDA_NAME")
                  echo "  ‚úì Detected: $LAMBDA_NAME"
                else
                  echo "  ‚äò Skipped: $LAMBDA_NAME (no package.json)"
                fi
              fi
            done
            
            # Convert array to comma-separated string
            if [ ${#DETECTED_LAMBDAS[@]} -eq 0 ]; then
              echo "‚ùå No lambdas found in $LAMBDAS_DIR"
              exit 1
            fi
            
            LAMBDA_NAMES=$(IFS=,; echo "${DETECTED_LAMBDAS[*]}")
            echo "‚úÖ Auto-detected ${#DETECTED_LAMBDAS[@]} lambda(s): $LAMBDA_NAMES"
          else
            echo "üìã Using provided lambda names: $LAMBDA_NAMES"
          fi

          # Save to output and environment
          echo "lambda_names=$LAMBDA_NAMES" >> $GITHUB_OUTPUT
          echo "LAMBDA_NAMES=$LAMBDA_NAMES" >> $GITHUB_ENV

          # Count lambdas
          IFS=',' read -ra LAMBDAS <<< "$LAMBDA_NAMES"
          COUNT=${#LAMBDAS[@]}
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "üì¶ Total lambda functions to build: $COUNT"

      # ========================================
      # Install Dependencies for All Lambdas
      # ========================================

      - name: Install dependencies for all lambdas
        run: |
          echo "üì• Installing dependencies for all lambdas..."

          IFS=',' read -ra LAMBDAS <<< "${{ steps.parse-lambdas.outputs.lambda_names }}"

          for LAMBDA in "${LAMBDAS[@]}"; do
            LAMBDA=$(echo "$LAMBDA" | xargs)  # Trim whitespace
            LAMBDA_PATH="${{ inputs.lambdas-directory }}/$LAMBDA"
            
            if [ -d "$LAMBDA_PATH" ]; then
              echo ""
              echo "üì¶ Installing dependencies for: $LAMBDA"
              cd "$LAMBDA_PATH"
              
              if [ -f "package.json" ]; then
                npm ci
                echo "‚úÖ Dependencies installed for $LAMBDA"
              else
                echo "‚ö†Ô∏è No package.json found for $LAMBDA, skipping..."
              fi
              
              cd - > /dev/null
            else
              echo "‚ùå Lambda directory not found: $LAMBDA_PATH"
              exit 1
            fi
          done

          echo ""
          echo "‚úÖ All dependencies installed"

      # ========================================
      # Build TypeScript for All Lambdas
      # ========================================

      - name: Build all lambdas
        run: |
          echo "üî® Building all lambdas..."

          IFS=',' read -ra LAMBDAS <<< "${{ steps.parse-lambdas.outputs.lambda_names }}"

          for LAMBDA in "${LAMBDAS[@]}"; do
            LAMBDA=$(echo "$LAMBDA" | xargs)  # Trim whitespace
            LAMBDA_PATH="${{ inputs.lambdas-directory }}/$LAMBDA"
            
            echo ""
            echo "üî® Building: $LAMBDA"
            cd "$LAMBDA_PATH"
            
            if [ -f "package.json" ] && grep -q '"build"' package.json; then
              npm run build
              echo "‚úÖ Build completed for $LAMBDA"
            else
              echo "‚ö†Ô∏è No build script found for $LAMBDA, skipping build..."
            fi
            
            cd - > /dev/null
          done

          echo ""
          echo "‚úÖ All builds completed"

      # ========================================
      # Package Lambdas
      # ========================================

      - name: Create output directory
        run: |
          mkdir -p ${{ inputs.output-directory }}
          echo "‚úÖ Output directory created: ${{ inputs.output-directory }}"

      - name: Package all lambdas
        id: package
        run: |
          echo "üì¶ Packaging all lambdas..."

          IFS=',' read -ra LAMBDAS <<< "${{ steps.parse-lambdas.outputs.lambda_names }}"
          PACKAGE_COUNT=0

          for LAMBDA in "${LAMBDAS[@]}"; do
            LAMBDA=$(echo "$LAMBDA" | xargs)  # Trim whitespace
            LAMBDA_PATH="${{ inputs.lambdas-directory }}/$LAMBDA"
            OUTPUT_ZIP="${{ inputs.output-directory }}/${LAMBDA}.zip"
            
            echo ""
            echo "üì¶ Packaging: $LAMBDA"
            cd "$LAMBDA_PATH"
            
            # Determine what to include in the package
            PACKAGE_ITEMS=""
            
            # Check for build directory
            if [ -d "${{ inputs.build-directory }}" ]; then
              PACKAGE_ITEMS="${{ inputs.build-directory }}/"
              echo "  ‚úì Including build directory"
            fi
            
            # Check for node_modules
            if [ "${{ inputs.include-node-modules }}" == "true" ] && [ -d "node_modules" ]; then
              PACKAGE_ITEMS="$PACKAGE_ITEMS node_modules/"
              echo "  ‚úì Including node_modules"
            fi
            
            # Check for package.json and package-lock.json
            if [ "${{ inputs.include-package-json }}" == "true" ]; then
              if [ -f "package.json" ]; then
                PACKAGE_ITEMS="$PACKAGE_ITEMS package.json"
                echo "  ‚úì Including package.json"
              fi
              
              if [ -f "package-lock.json" ]; then
                PACKAGE_ITEMS="$PACKAGE_ITEMS package-lock.json"
                echo "  ‚úì Including package-lock.json"
              fi
            fi
            
            # Create ZIP
            if [ -n "$PACKAGE_ITEMS" ]; then
              zip -r "../../${OUTPUT_ZIP}" $PACKAGE_ITEMS
              PACKAGE_COUNT=$((PACKAGE_COUNT + 1))
              echo "‚úÖ Package created: ${OUTPUT_ZIP}"
            else
              echo "‚ö†Ô∏è No files to package for $LAMBDA"
            fi
            
            cd - > /dev/null
          done

          echo ""
          echo "‚úÖ All packages created: $PACKAGE_COUNT"
          echo "package_count=$PACKAGE_COUNT" >> $GITHUB_OUTPUT

      # ========================================
      # Summary
      # ========================================

      - name: List created packages
        id: count
        run: |
          echo "### üì¶ Lambda Packages Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "${{ inputs.output-directory }}" ]; then
            FILE_COUNT=$(ls -1 ${{ inputs.output-directory }}/*.zip 2>/dev/null | wc -l)
            
            if [ "$FILE_COUNT" -gt 0 ]; then
              echo "**Total packages:** $FILE_COUNT" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              ls -lh ${{ inputs.output-directory }}/*.zip >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Package sizes:**" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              du -h ${{ inputs.output-directory }}/*.zip >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              
              echo "count=$FILE_COUNT" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è No packages found" >> $GITHUB_STEP_SUMMARY
              echo "count=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Output directory not found" >> $GITHUB_STEP_SUMMARY
            echo "count=0" >> $GITHUB_OUTPUT
          fi

      # ========================================
      # Upload Artifacts
      # ========================================

      - name: Upload Lambda artifacts
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.output-directory }}/*.zip
          retention-days: ${{ inputs.retention-days }}
          if-no-files-found: error

      - name: Build summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Lambda functions:** ${{ steps.parse-lambdas.outputs.lambda_names }}" >> $GITHUB_STEP_SUMMARY
          echo "**Node.js version:** ${{ inputs.node-version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Packages created:** ${{ steps.package.outputs.package_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact name:** ${{ inputs.artifact-name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Upload status:** ${{ steps.upload.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
