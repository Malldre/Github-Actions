name: "Terraform Provider Validation"

on:
    workflow_call:
        inputs:
            environment:
                description: "Target environment"
                required: true
                type: string
            working-directory:
                description: "Working directory for Terraform files"
                required: false
                type: string
                default: "infra"
            fail-on-missing:
                description: "Fail if provider default_tags missing"
                required: false
                type: boolean
                default: true

permissions:
    contents: read

jobs:
    validate-provider:
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Validate AWS Provider
              working-directory: ${{ inputs.working-directory }}
              run: |
                  echo "ðŸ” Validating AWS Provider configuration..."

                  cat > validate.py << 'EOF'
                  import re
                  import sys
                  from pathlib import Path

                  required = ['UpdatedBy', 'Environment', 'ManagedBy', 'Repository']

                  for tf in Path('.').rglob('*.tf'):
                      content = tf.read_text()
                      match = re.search(r'provider\s+"aws"\s*\{(.+?)\n\}', content, re.DOTALL)
                      
                      if match:
                          print(f"âœ… Found provider in: {tf}")
                          provider = match.group(1)
                          
                          if 'default_tags' not in provider:
                              print("âŒ Missing default_tags block")
                              sys.exit(1)
                          
                          missing = [t for t in required if t not in provider]
                          if missing:
                              print(f"âŒ Missing tags: {', '.join(missing)}")
                              sys.exit(1)
                          
                          print(f"âœ… All tags present: {', '.join(required)}")
                          sys.exit(0)

                  print("âŒ No AWS provider found")
                  sys.exit(1)
                  EOF

                  python3 validate.py

                  if [ $? -eq 0 ] && [ "${{ inputs.fail-on-missing }}" == "false" ]; then
                    echo "âš ï¸ Validation issues found but continuing (fail-on-missing: false)"
                    exit 0
                  fi

            - name: Summary
              if: always()
              run: |
                  echo "## ðŸ·ï¸ Provider Validation" >> $GITHUB_STEP_SUMMARY
                  echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Directory:** ${{ inputs.working-directory }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Required Tags" >> $GITHUB_STEP_SUMMARY
                  echo "- UpdatedBy" >> $GITHUB_STEP_SUMMARY
                  echo "- Environment" >> $GITHUB_STEP_SUMMARY
                  echo "- ManagedBy" >> $GITHUB_STEP_SUMMARY
                  echo "- Repository" >> $GITHUB_STEP_SUMMARY
