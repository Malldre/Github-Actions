name: "Auto-Tag Terraform Resources"

on:
    workflow_call:
        inputs:
            environment:
                description: "Target environment"
                required: true
                type: string
            working-directory:
                description: "Working directory for Terraform files"
                required: false
                type: string
                default: "infra"
            additional-tags:
                description: "Additional custom tags (JSON format)"
                required: false
                type: string
                default: "{}"
            create-pr:
                description: "Create PR with changes"
                required: false
                type: boolean
                default: true

permissions:
    contents: write
    pull-requests: write

jobs:
    auto-tag:
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Auto-Tag Resources
              id: auto-tag
              run: |
                  echo "🏷️ Auto-tagging Terraform resources..."

                  # Default tags
                  REPO_NAME="${{ github.repository }}"
                  REPO_SHORT="${REPO_NAME#*/}"
                  ENVIRONMENT="${{ inputs.environment }}"

                  cat > /tmp/auto_tag.py << 'PYTHON_SCRIPT'
                  import os
                  import re
                  import json
                  import sys
                  from pathlib import Path

                  def parse_additional_tags(tags_json):
                      try:
                          return json.loads(tags_json)
                      except:
                          return {}

                  def get_default_tags(repo, env, additional):
                      tags = {
                          "Environment": env,
                          "ManagedBy": "Terraform",
                          "Repository": repo,
                          "CreatedBy": "GitHub-Actions"
                      }
                      tags.update(additional)
                      return tags

                  def format_tags_block(tags, indent=2):
                      spaces = " " * indent
                      lines = [f"{spaces}tags = {{"]
                      for key, value in sorted(tags.items()):
                          lines.append(f'{spaces}  {key:<15} = "{value}"')
                      lines.append(f"{spaces}}}")
                      return "\n".join(lines)

                  def process_terraform_file(file_path, default_tags):
                      with open(file_path, 'r') as f:
                          content = f.read()
                      
                      original_content = content
                      modified = False
                      
                      # Resources that don't support tags
                      NO_TAG_RESOURCES = [
                          'aws_iam_role_policy_attachment',
                          'aws_iam_policy_attachment',
                          'aws_iam_user_policy_attachment',
                          'aws_iam_group_policy_attachment',
                          'aws_lambda_permission',
                          'aws_cloudwatch_log_subscription_filter',
                          'aws_route53_record',
                          'aws_route53_zone_association',
                          'aws_security_group_rule',
                          'aws_vpc_endpoint_route_table_association',
                          'aws_subnet_ids',
                          'aws_route_table_association'
                      ]
                      
                      def find_matching_brace(text, start_pos):
                          """Find the closing brace for a resource block"""
                          count = 0
                          in_string = False
                          escape_next = False
                          
                          for i in range(start_pos, len(text)):
                              char = text[i]
                              
                              if escape_next:
                                  escape_next = False
                                  continue
                              
                              if char == '\\':
                                  escape_next = True
                                  continue
                              
                              if char == '"':
                                  in_string = not in_string
                                  continue
                              
                              if not in_string:
                                  if char == '{':
                                      count += 1
                                  elif char == '}':
                                      count -= 1
                                      if count == 0:
                                          return i
                          
                          return -1
                      
                      # Pattern to match resource declarations
                      resource_pattern = r'resource\s+"([^"]+)"\s+"([^"]+)"\s+\{'
                      
                      new_content = content
                      offset = 0
                      
                      for match in re.finditer(resource_pattern, content):
                          resource_type = match.group(1)
                          resource_name = match.group(2)
                          start_pos = match.end()
                          
                          # Skip resources that don't support tags
                          if resource_type in NO_TAG_RESOURCES:
                              continue
                          
                          # Find the closing brace
                          closing_brace_pos = find_matching_brace(content, start_pos)
                          if closing_brace_pos == -1:
                              continue
                          
                          # Get the resource block content
                          resource_content = content[start_pos:closing_brace_pos]
                          
                          # Check if tags already exist
                          if re.search(r'\n\s*tags\s*=\s*\{', resource_content):
                              continue
                          
                          # Find proper indentation
                          lines_before = content[:match.start()].split('\n')
                          indent = len(lines_before[-1]) if lines_before else 0
                          
                          # Add tags before closing brace
                          tags_block = format_tags_block(default_tags, indent=indent+2)
                          
                          # Calculate position in new_content with offset
                          insert_pos = closing_brace_pos + offset
                          
                          # Insert tags
                          new_content = (
                              new_content[:insert_pos] + 
                              "\n\n" + tags_block + "\n" + 
                              new_content[insert_pos:]
                          )
                          
                          offset += len("\n\n" + tags_block + "\n")
                          modified = True
                      
                      if modified:
                          with open(file_path, 'w') as f:
                              f.write(new_content)
                          return True
                      
                      return False

                  def main():
                      repo = sys.argv[1]
                      env = sys.argv[2]
                      working_dir = sys.argv[3]
                      additional_json = sys.argv[4] if len(sys.argv) > 4 else "{}"
                      
                      additional = parse_additional_tags(additional_json)
                      default_tags = get_default_tags(repo, env, additional)
                      
                      print(f"Default tags: {json.dumps(default_tags, indent=2)}")
                      
                      files_modified = []
                      tf_dir = Path(working_dir)
                      
                      for tf_file in tf_dir.rglob("*.tf"):
                          if process_terraform_file(tf_file, default_tags):
                              files_modified.append(str(tf_file))
                              print(f"✅ Tagged: {tf_file}")
                      
                      print(f"\nModified {len(files_modified)} files")
                      
                      with open("/tmp/modified_files.txt", "w") as f:
                          f.write("\n".join(files_modified))
                      
                      return len(files_modified)

                  if __name__ == "__main__":
                      count = main()
                      sys.exit(0 if count >= 0 else 1)
                  PYTHON_SCRIPT

                  # Run the script
                  python /tmp/auto_tag.py \
                    "$REPO_SHORT" \
                    "$ENVIRONMENT" \
                    "${{ inputs.working-directory }}" \
                    '${{ inputs.additional-tags }}'

                  MODIFIED_COUNT=$(wc -l < /tmp/modified_files.txt 2>/dev/null || echo "0")
                  echo "modified-count=$MODIFIED_COUNT" >> $GITHUB_OUTPUT

                  if [ "$MODIFIED_COUNT" -gt 0 ]; then
                    echo "✅ Auto-tagged $MODIFIED_COUNT files"
                    echo "## 🏷️ Auto-Tagging Report" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "**Files Modified:** $MODIFIED_COUNT" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "**Modified Files:**" >> $GITHUB_STEP_SUMMARY
                    echo '```' >> $GITHUB_STEP_SUMMARY
                    cat /tmp/modified_files.txt >> $GITHUB_STEP_SUMMARY
                    echo '```' >> $GITHUB_STEP_SUMMARY
                  else
                    echo "ℹ️ No files needed tagging"
                  fi

            - name: Format Terraform Files
              if: steps.auto-tag.outputs.modified-count > 0
              run: |
                  cd ${{ inputs.working-directory }}
                  terraform fmt -recursive || true

            - name: Create Pull Request
              if: steps.auto-tag.outputs.modified-count > 0 && inputs.create-pr == true
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: "chore: auto-tag terraform resources for ${{ inputs.environment }}"
                  title: "🏷️ Auto-tag Terraform resources for ${{ inputs.environment }}"
                  body: |
                      ## Auto-Tagging Report

                      This PR automatically adds tags to Terraform resources for the **${{ inputs.environment }}** environment.

                      ### Tags Added:
                      - **Environment**: ${{ inputs.environment }}
                      - **ManagedBy**: Terraform
                      - **Repository**: ${{ github.repository }}
                      - **CreatedBy**: GitHub-Actions

                      ### Files Modified: ${{ steps.auto-tag.outputs.modified-count }}

                      All resources now have consistent tagging for better resource management and cost tracking.
                  branch: auto-tag/${{ inputs.environment }}-${{ github.run_number }}
                  delete-branch: true
                  labels: |
                      terraform
                      auto-tag
                      chore

            - name: Commit Changes Directly
              if: steps.auto-tag.outputs.modified-count > 0 && inputs.create-pr == false
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  git add ${{ inputs.working-directory }}
                  git commit -m "chore: auto-tag terraform resources for ${{ inputs.environment }}"
                  git push
